<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/common :: common-head}">
    <title>회원가입</title>
</head>
<body>
<div class="container">
    <form th:method="post" class="form-register" th:action="@{~/member/register}">
        <h2>회원가입</h2>
        <div class="mb-3">
            <input type="email" class="form-control" id="email" name="email" placeholder="이메일">
            <span class="text-danger" id="error-email"></span>
        </div>
        <div class="mb-3">
            <input type="password" class="form-control" id="password" name="password" placeholder="비밀번호">
        </div>
        <div class="mb-3">
            <input type="password" class="form-control" id="password-check" name="password-check" placeholder="비밀번호 확인">
            <span class="text-danger" id="error-password"></span>
        </div>
        <div class="mb-3">
            <input type="tel" class="form-control" id="phone" name="phone" placeholder="010-1234-5678">
            <span class="text-danger" id="error-phone"></span>
        </div>
        <div class="mb-3">
            <button type="button" class="btn-primary" id="btn-register">회원가입</button>
        </div>
    </form>
</div>

<script>
    $(function () {
        $('#btn-register').click(function () {
            validate();
        });
    });

    const regexp = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$/;

    function validate() {
        let email = $('#email').val();
        let password = $('#password').val();
        let passwordCheck = $('#password-check').val();
        let phone = $('#phone').val();
        let hasError = false;

        if (!email) {
            $('#error-email').text('이메일을 입력하세요.').css('visibility', 'visible');
            hasError = true;
        } else {
            $.ajax({
                type: 'post',
                url: 'api/v1/register',
                data: JSON.stringify({
                    email: email
                }),
                contentType: 'application/json',
                dataType: 'json',
                success: function (response) {
                    if (response.isExists) {
                        hasError = true;
                        $('#error-email').text('이미 가입된 회원입니다. 다시 한번 확인하세요.').css('visibility', 'visible');
                    } else {
                        $('#error-email').css('visibility', 'hidden');
                    }
                },
                error: function () {
                    $('#error').text('예기치 못한 오류가 발생했습니다.').css('visibility', 'visible');
                }
            });
        }

        if (!password || !passwordCheck) {
            $('#error-password').text('비밀번호를 입력하세요.').css('visibility', 'visible');
            hasError = true;
        } else {
            if (!regexp.test(password)) {
                $('#error-password').text('비밀번호는 8자 이상이고, 하나의 소문자, 대문자, 특수문자를 포함해야 합니다.').css("visibility", true);
                hasError = true;
            } else if (password !== passwordCheck) {
                $('#error-password').text('비밀번호가 일치하지 않습니다.').css('visibility', 'visible');
                hasError = true;
            } else {
                $('#error-password').css('visibility', 'hidden');
            }
        }

        if (!phone) {
            $('#error-phone').text('전화번호를 입력하세요.').css('visibility', 'visible');
            hasError = true;
        } else {
            $('#error-phone').css('visibility', 'hidden');
        }

        if (!hasError) {
            $('.form-register').submit();
        }
    }
</script>
</body>
</html>